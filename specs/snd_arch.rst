
RRPGE Audio architecture
==============================================================================

:Author:    Sandor Zsuga (Jubatian)
:Copyright: 2013 - 2014, GNU GPLv3 (version 3 of the GNU General Public
            License) extended as RRPGEvt (temporary version of the RRPGE
            License): see LICENSE.GPLv3 and LICENSE.RRPGEvt in the project
            root.




Introduction
------------------------------------------------------------------------------


This part defines how audio output is generated by the RRPGE system, only
covering the actual audio output, not including the Mixer peripheral (see
"mix_arch.rst" for further details on this component).




Basic properties of the audio output
------------------------------------------------------------------------------


The audio output capabilities of the system can be summarized as follows:

- Digital audio output only
- 16 bit unsigned sample data
- Two channel stereo output (mono output can also be used)
- The output is governed by hardware DMA
- 48 KHz sampling frequency is supported
- Clock for real time synchronization




Output DMA buffers
------------------------------------------------------------------------------


The audio output DMA operates on the Peripheral bus, accessing the Peripheral
RAM.

Separate left & right channel DMA start offsets are provided. The buffer size
is defined by a mask which mixes bits from the DMA sample counter and these
start offset bits, normally selecting the higher bits from the start offsets,
the lower bits from the DMA sample counter.

Mono output may be realized by making the left & right channel DMA offsets
equal.

Note that the audio output DMA uses a left and a right sample (16 bits) every
audio base clock tick. This is half of a 32 bit PRAM cell. The lowest bit of
the Audio DMA sample counter selects the sample of the sample source cell to
use (0 selecting the high 16 bits, 1 selecting the low 16 bits).




Audio output memory map
------------------------------------------------------------------------------


The following table lists the memory addresses within the User peripheral area
which relate the audio output DMA.

+--------+-------------------------------------------------------------------+
| Range  | Description                                                       |
+========+===================================================================+
| 0x0000 | Unused, writes ignored, reads 0x0000 ("NULL" pointer target)      |
+--------+-------------------------------------------------------------------+
| 0x0001 | 187.5Hz clock (48KHz / 256; incrementing counter), writes ignored |
+--------+-------------------------------------------------------------------+
|        | Audio DMA sample counter / next sample read offset. Derived from  |
| 0x0002 | the base clock after applying the divider. Writes to this field   |
|        | are ignored. The high 15 bits of this register are used to        |
|        | generate a PRAM offset for the DMA, the lowest bit is used to     |
|        | select the sample to use within the selected cell (assuming Big   |
|        | Endian byte order).                                               |
+--------+-------------------------------------------------------------------+
|        | Audio DMA base clock. Increments starting with zero at a fixed    |
| 0x0003 | 48 KHz rate until reaching the divider, resetting to zero when    |
|        | it matches. Writes to this field are ignored.                     |
+--------+-------------------------------------------------------------------+
| 0x0004 | Audio left channel DMA start offset bits, specifying offset bits  |
|        | 4 - 19. Low 4 start offset bits are always zero.                  |
+--------+-------------------------------------------------------------------+
| 0x0005 | Audio right channel DMA start offset bits, specifying offset bits |
|        | 4 - 19. Low 4 start offset bits are always zero.                  |
+--------+-------------------------------------------------------------------+
|        | Audio DMA buffer size mask bits, specifying mask for offset bits  |
| 0x0006 | 4 - 19. Bits set in this mask come from the DMA start offset,     |
|        | bits cleared from the DMA sample counter. Note that since the DMA |
|        | sample counter only provides data for bits 0 - 14, bits 15 - 19   |
|        | will be zero if the corresponding mask bits are cleared.          |
+--------+-------------------------------------------------------------------+
|        | Audio clock divider. Writing it zero produces a sample counter    |
| 0x0007 | increment every 65536 base clocks. 1 produces a 48KHz sample      |
|        | counter increment rate, the Audio DMA base clock always reading   |
|        | zero. Writing it resets the Audio DMA base clock to zero.         |
+--------+-------------------------------------------------------------------+
