
RRPGE Audio architecture
==============================================================================

:Author:    Sandor Zsuga (Jubatian)
:Copyright: 2013 - 2014, GNU GPLv3 (version 3 of the GNU General Public
            License) extended as RRPGEv2 (version 2 of the RRPGE License): see
            LICENSE.GPLv3 and LICENSE.RRPGEv2 in the project root.




Introduction
------------------------------------------------------------------------------


This part defines how audio output is generated by the RRPGE system, only
covering the actual audio output, not including the Mixer peripheral (see
"mix_arch.rst" for further details on this component).




Basic properties of the audio output
------------------------------------------------------------------------------


The audio output capabilities of the system can be summarized as follows:

- Digital audio output only
- 8 bit unsigned sample data
- Two channel stereo output (mono output can also be used)
- The output is governed by hardware DMA
- 48 KHz sampling frequency is supported
- Clock for real time synchronization

The audio output's DMA sample counter should be used to synchronize to real
time by applications.




Output DMA buffers
------------------------------------------------------------------------------


The audio output DMA is capable to operate from the first 1 MWords (pages
0x4000 - 0x40FF) of the Data memory.

Seperate left & right channel DMA start offsets can select a region from this
area where the audio output DMA may operate. The buffer size is defined by a
mask which mixes bits from the DMA sample counter and these start offset bits,
normally selecting the higher bits from the start offsets, the lower bits from
the DMA sample counter.

Mono output may be used by making the left & right channel DMA offsets equal.

Note that the audio output DMA uses a left and a right sample (8 bits) every
audio base clock tick. This is half of a 16 bit word. The lowest bit of the
Audio DMA sample counter selects the high (0) or low (1) byte of the sample
source word to use.




Audio output memory map
------------------------------------------------------------------------------


The following table lists the memory addresses within the User peripheral page
which relate the audio output DMA. Note that these repeat every 32 words in
the 0xF00 - 0xFFF range within this page.

+--------+-------------------------------------------------------------------+
| Range  | Description                                                       |
+========+===================================================================+
| 0xF08  | Audio left channel DMA start offset bits, specifying offset bits  |
|        | 4 - 19. Low 4 start offset bits are always zero.                  |
+--------+-------------------------------------------------------------------+
| 0xF09  | Audio right channel DMA start offset bits, specifying offset bits |
|        | 4 - 19. Low 4 start offset bits are always zero.                  |
+--------+-------------------------------------------------------------------+
|        | Audio DMA buffer size mask bits, specifying mask for offset bits  |
| 0xF0A  | 4 - 19. Bits set in this mask come from the DMA start offset,     |
|        | bits cleared from the DMA sample counter. Note that since the DMA |
|        | sample counter only provides data for bits 0 - 14, bits 15 - 19   |
|        | will be zero if the corresponding mask bits are cleared.          |
+--------+-------------------------------------------------------------------+
|        | Audio clock divider. Writing it zero produces a sample counter    |
| 0xF0B  | increment every 65536 base clocks. 1 produces a 48KHz sample      |
|        | counter increment rate, the Audio DMA base clock always reading   |
|        | zero. Writing it resets the Audio DMA base clock to zero.         |
+--------+-------------------------------------------------------------------+
|        | Audio DMA sample counter / next sample read offset. Derived from  |
| 0xF0C  | the base clock after applying the divider. Writes to this field   |
|        | are ignored.                                                      |
+--------+-------------------------------------------------------------------+
|        | Audio DMA base clock. Increments starting with zero at a fixed    |
| 0xF0D  | 48 KHz rate until reaching the divider, resetting to zero when.   |
|        | it matches. Writes to this field are ignored.                     |
+--------+-------------------------------------------------------------------+
